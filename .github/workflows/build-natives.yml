# Build all JNI natives and assemble a final JAR that includes every platform's shared library
name: Build Natives and Assemble All-Platforms Jar

on:
  push:
    branches: [ main, workflow ]
    tags: [ 'v*' ]
  pull_request:

jobs:
  linux:
    name: Linux natives (${{ matrix.arch }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            cc: gcc
            cflags: ""
            ldflags: ""
            apt: ""
          - arch: i386
            cc: gcc
            cflags: "-m32"
            ldflags: ""
            apt: "gcc-multilib libc6-dev-i386"
          - arch: aarch64
            cc: aarch64-linux-gnu-gcc
            cflags: ""
            ldflags: ""
            apt: "gcc-aarch64-linux-gnu"
          - arch: ppc64le
            cc: powerpc64le-linux-gnu-gcc
            cflags: ""
            ldflags: ""
            apt: "gcc-powerpc64le-linux-gnu"
          - arch: s390x
            cc: s390x-linux-gnu-gcc
            cflags: ""
            ldflags: ""
            apt: "gcc-s390x-linux-gnu"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Install cross toolchain (if needed)
        if: ${{ matrix.apt != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.apt }}

      - name: Build (mvn package)
        run: |
          ./mvnw -B -V -DskipTests \
            -Darch.id=${{ matrix.arch }} \
            -Dnative.cc=${{ matrix.cc }} \
            "-Dnative.cflags=${{ matrix.cflags }}" \
            "-Dnative.ldflags=${{ matrix.ldflags }}" \
            package

      - name: Upload native library (directory with correct in-jar path)
        uses: actions/upload-artifact@v4
        with:
          name: natives-linux-${{ matrix.arch }}
          path: target/classes/net
          if-no-files-found: error

      - name: Upload base jar (linux/amd64 only)
        if: ${{ matrix.arch == 'amd64' }}
        uses: actions/upload-artifact@v4
        with:
          name: base-jar
          path: target/lz4-java-*.jar
          if-no-files-found: error

  macos:
    name: macOS natives (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-13
            arch: amd64   # x86_64
          - os: macos-14
            arch: aarch64 # arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build (mvn package)
        run: |
          ./mvnw -B -V -DskipTests \
            -Darch.id=${{ matrix.arch }} \
            -Dnative.cc=cc \
            package

      - name: Upload native library (directory with correct in-jar path)
        uses: actions/upload-artifact@v4
        with:
          name: natives-darwin-${{ matrix.arch }}
          path: target/classes/net
          if-no-files-found: error

  windows:
    name: Windows natives (win32/amd64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup MSYS2 with Mingw-w64
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-gcc

      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build (mvn package) using MSYS2 shell
        shell: msys2 {0}
        run: |
          ./mvnw -B -V -DskipTests \
            -Darch.id=amd64 \
            -Dnative.cc=gcc \
            package

      - name: Upload native library (directory with correct in-jar path)
        uses: actions/upload-artifact@v4
        with:
          name: natives-win32-amd64
          path: target/classes/net
          if-no-files-found: error

  assemble:
    name: Assemble final all-platforms JAR
    runs-on: ubuntu-latest
    needs: [ linux, macos, windows ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0


      - name: Download natives (linux)
        uses: actions/download-artifact@v4
        with:
          path: assemble/natives
      # Note: downloads all artifacts; we will merge their folder contents

      - name: Prepare src/resources with collected natives
        run: |
          rm -rf src/resources/net/jpountz/util || true
          mkdir -p src/resources/net
          # Merge all downloaded artifacts into a single src/resources/net tree
          # Each artifact contains net/jpountz/util/<os>/<arch>/liblz4-java.{ext}
          find assemble/natives -type d -name net -print0 | while IFS= read -r -d '' d; do
            rsync -a "$d"/ src/resources/net/
          done
          echo "Contents of src/resources/net:"
          find src/resources/net -maxdepth 3 -type f -print


      - name: Build with Maven (tests + package) consuming staged natives
        run: ./mvnw -B -V test package

      - name: Upload final JAR
        uses: actions/upload-artifact@v4
        with:
          name: lz4-java-all-platforms
          path: target/lz4-java-*.jar
          if-no-files-found: error
