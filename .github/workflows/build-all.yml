# Build all JNI natives and assemble a final JAR that includes every platform's shared library
name: Build Natives and Assemble All-Platforms Jar

on:
  push:
    tags: [ 'v*' ]

jobs:
  linux:
    name: Linux natives (${{ matrix.arch }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            cc: gcc
            cflags: ""
            ldflags: ""
            apt: ""
          - arch: i386
            cc: gcc
            cflags: "-m32"
            ldflags: ""
            apt: "gcc-multilib libc6-dev-i386"
          - arch: aarch64
            cc: aarch64-linux-gnu-gcc
            cflags: ""
            ldflags: ""
            apt: "gcc-aarch64-linux-gnu"
          - arch: ppc64le
            cc: powerpc64le-linux-gnu-gcc
            cflags: ""
            ldflags: ""
            apt: "gcc-powerpc64le-linux-gnu"
          - arch: s390x
            cc: s390x-linux-gnu-gcc
            cflags: ""
            ldflags: ""
            apt: "gcc-s390x-linux-gnu"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Java 7 (Zulu) and write toolchains
        id: java7-linux
        uses: ./.github/actions/setup-java7-zulu

      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven


      - name: Install cross toolchain (if needed)
        if: ${{ matrix.apt != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.apt }}

      - name: Build (mvn verify on native linux/amd64)
        if: ${{ matrix.arch == 'amd64' }}
        run: |
          ./mvnw -B -V \
            -Darch.id=${{ matrix.arch }} \
            -Dnative.cc=${{ matrix.cc }} \
            "-Dnative.cflags=${{ matrix.cflags }}" \
            "-Dnative.ldflags=${{ matrix.ldflags }}" \
            verify

      - name: Build (mvn package on cross-compiled linux arches)
        if: ${{ matrix.arch != 'amd64' }}
        run: |
          ./mvnw -B -V -DskipTests \
            -Darch.id=${{ matrix.arch }} \
            -Dnative.cc=${{ matrix.cc }} \
            "-Dnative.cflags=${{ matrix.cflags }}" \
            "-Dnative.ldflags=${{ matrix.ldflags }}" \
            package

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: natives-linux-${{ matrix.arch }}
          path: target/classes/net/jpountz/util/linux/*/liblz4-java.so
          if-no-files-found: error


  macos:
    name: macOS natives (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-13
            arch: x86_64
            java7: true
          - os: macos-14
            arch: aarch64
            java7: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Java 7 (Zulu) and write toolchains
        if: ${{ matrix.java7 }}
        id: java7-macos
        uses: ./.github/actions/setup-java7-zulu

      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven


      - name: Build (process-resources only on macos-14)
        if: ${{ matrix.os == 'macos-14' }}
        run: |
          ./mvnw -B -V -DskipTests \
            -Darch.id=${{ matrix.arch }} \
            -Dnative.cc=cc \
            process-resources

      - name: Build (mvn verify on macos-13)
        if: ${{ matrix.os != 'macos-14' }}
        run: |
          ./mvnw -B -V \
            -Darch.id=${{ matrix.arch }} \
            -Dnative.cc=cc \
            verify

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: natives-darwin-${{ matrix.arch }}
          path: target/classes/net/jpountz/util/darwin/${{ matrix.arch }}/liblz4-java.dylib
          if-no-files-found: error

  windows:
    name: Windows natives (win32/amd64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup MSYS2 with Mingw-w64
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-lz4

      - name: Setup Java 7 (Zulu) and write toolchains
        uses: ./.github/actions/setup-java7-zulu


      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven


      - name: Build (mvn verify) using MSYS2 shell
        shell: msys2 {0}
        run: |
          ./mvnw -B -V \
            -Darch.id=amd64 \
            -Dnative.cc=gcc \
            verify

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: natives-win32-amd64
          path: target/classes/net/jpountz/util/win32/amd64/liblz4-java.so
          if-no-files-found: error

  assemble:
    name: Assemble final all-platforms JAR
    runs-on: ubuntu-latest
    needs: [ linux, macos, windows ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Java 7 (Zulu) and write toolchains
        id: java7
        uses: ./.github/actions/setup-java7-zulu

      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven


      - name: Download natives
        uses: actions/download-artifact@v4
        with:
          path: assemble/natives
      # Note: downloads all artifacts; we will merge their folder contents

      - name: Prepare src/resources with collected natives
        shell: bash
        run: |
          rm -rf src/resources/net/jpountz/util || true
          shopt -s nullglob
          for dir in assemble/natives/*; do
            base="$(basename "$dir")"
            # Expect names like natives-linux-amd64, natives-darwin-aarch64, natives-win32-amd64
            os="${base#natives-}"
            arch="${os#*-}"; os="${os%%-*}"
            case "$os" in
              linux) ext=so ;;
              darwin) ext=dylib ;;
              win32) ext=so ;;
              *) echo "Unknown OS in artifact: $base" >&2; continue ;;
            esac
            dest="src/resources/net/jpountz/util/$os/$arch"
            mkdir -p "$dest"
            if [ -f "$dir/liblz4-java.$ext" ]; then
              cp -f "$dir/liblz4-java.$ext" "$dest/"
            else
              found="$(find "$dir" -type f -name "liblz4-java.$ext" | head -n1)"
              if [ -n "$found" ]; then
                cp -f "$found" "$dest/"
              else
                echo "No lib found in $dir" >&2
              fi
            fi
          done
          echo "Contents of src/resources/net:"
          find src/resources/net -maxdepth 3 -type f -print


      - name: Build with Maven (verify) consuming staged natives
        run: ./mvnw -B -V verify

      - name: Upload final JAR
        uses: actions/upload-artifact@v4
        with:
          name: lz4-java-all-platforms
          path: target/lz4-java-*.jar
          if-no-files-found: error
